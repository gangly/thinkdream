<?php

header("Content-type:text/html;charset=utf-8");

//传递数据以易于阅读的样式格式化后输出
function p($data) {
	echo '<pre style="display: block;padding: 9.5px;margin: 0px 0px 10px;font-size: 13px;line-height: 1.42857;color: #333;word-break: break-all;word-wrap: break-word;background-color: #F5F5F5;border: 1px solid #CCC;border-radius: 4px;">' . print_r($data, true) . '</pre>';
}
/**
 * 删除指定的标签和内容
 * @param array $tags 需要删除的标签数组
 * @param string $str 数据源
 * @param string $content 是否删除标签内的内容 0保留内容 1不保留内容
 * @return string
 */
function strip_html_tags($tags, $str, $content = 0) {
	if ($content) {
		$html = array();
		foreach ($tags as $tag) {
			$html[] = '/(<' . $tag . '.*?>[\s|\S]*?<\/' . $tag . '>)/';
		}
		$data = preg_replace($html, '', $str);
	} else {
		$html = array();
		foreach ($tags as $tag) {
			$html[] = "/(<(?:\/" . $tag . "|" . $tag . ")[^>]*>)/i";
		}
		$data = preg_replace($html, '', $str);
	}
	return $data;
}

//传递ueditor生成的内容获取其中图片的路径
function get_ueditor_image_path($str) {
	$preg = '/\/Upload\/image\/ueditor\/\d*\/\d*\.[jpg|jpeg|png|bmp]*/i';
	preg_match_all($preg, $str, $data);
	return current($data);
}

/**
 * 字符串截取，支持中文和其他编码
 * @param string $str 需要转换的字符串
 * @param string $start 开始位置
 * @param string $length 截取长度
 * @param string $suffix 截断显示字符
 * @param string $charset 编码格式
 * @return string
 */
function re_substr($str, $start = 0, $length, $suffix = true, $charset = "utf-8") {
	if (function_exists("mb_substr")) {
		$slice = mb_substr($str, $start, $length, $charset);
	} elseif (function_exists('iconv_substr')) {
		$slice = iconv_substr($str, $start, $length, $charset);
	} else {
		$re['utf-8'] = "/[\x01-\x7f]|[\xc2-\xdf][\x80-\xbf]|[\xe0-\xef][\x80-\xbf]{2}|[\xf0-\xff][\x80-\xbf]{3}/";
		$re['gb2312'] = "/[\x01-\x7f]|[\xb0-\xf7][\xa0-\xfe]/";
		$re['gbk'] = "/[\x01-\x7f]|[\x81-\xfe][\x40-\xfe]/";
		$re['big5'] = "/[\x01-\x7f]|[\x81-\xfe]([\x40-\x7e]|\xa1-\xfe])/";
		preg_match_all($re[$charset], $str, $match);
		$slice = join("", array_slice($match[0], $start, $length));
	}
	return $suffix ? $slice . '...' : $slice;
}

//传递图片路径根据配置项添加水印
function add_water($path) {
	$image = new \Think\Image();
	if (C('WATER_TYPE') == 1) {
		$image->open($path)->text(C('TEXT_WATER_WORD'), C('TEXT_WATER_TTF_PTH'), C('TEXT_WATER_FONT_SIZE'), C('TEXT_WATER_COLOR'), C('TEXT_WATER_LOCATE'), 0, C('TEXT_WATER_ANGLE'))->save($path);
	} elseif (C('WATER_TYPE') == 2) {
		$image->open($path)->water(C('IMAGE_WATER_PIC_PTAH'), C('IMAGE_WATER_LOCATE'), C('IMAGE_WATER_ALPHA'))->save($path);
	} elseif (C('WATER_TYPE') == 3) {
		$image->open($path)->text(C('TEXT_WATER_WORD'), C('TEXT_WATER_TTF_PTH'), C('TEXT_WATER_FONT_SIZE'), C('TEXT_WATER_COLOR'), C('TEXT_WATER_LOCATE'), 0, C('TEXT_WATER_ANGLE'))->save($path);
		$image->open($path)->water(C('IMAGE_WATER_PIC_PTAH'), C('IMAGE_WATER_LOCATE'), C('IMAGE_WATER_ALPHA'))->save($path);
	}
}

// 设置验证码
function show_verify($config = '') {
	if ($config == '') {
		$config = array(
			'codeSet' => '1234567890',
			'fontSize' => 30,
			'useCurve' => false,
			'imageH' => 60,
			'imageW' => 240,
			'length' => 4,
			'fontttf' => '4.ttf',
		);
	}
	$verify = new \Think\Verify($config);
	return $verify->entry();
}

// 检测验证码
function check_verify($code) {
	$verify = new \Think\Verify();
	return $verify->check($code);
}

/**
 * 取得根域名
 * @param type $domain 域名
 * @return string 返回根域名
 */
function getUrlToDomain($domain) {
	$re_domain = '';
	$domain_postfix_cn_array = array("com", "net", "org", "gov", "edu", "com.cn", "cn");
	$array_domain = explode(".", $domain);
	$array_num = count($array_domain) - 1;
	if ($array_domain[$array_num] == 'cn') {
		if (in_array($array_domain[$array_num - 1], $domain_postfix_cn_array)) {
			$re_domain = $array_domain[$array_num - 2] . "." . $array_domain[$array_num - 1] . "." . $array_domain[$array_num];
		} else {
			$re_domain = $array_domain[$array_num - 1] . "." . $array_domain[$array_num];
		}
	} else {
		$re_domain = $array_domain[$array_num - 1] . "." . $array_domain[$array_num];
	}
	return $re_domain;
}

/**
 * 按符号截取字符串的指定部分
 * @param string $str 需要截取的字符串
 * @param string $sign 需要截取的符号
 * @param int $number 如是正数以0为起点从左向右截  负数则从右向左截
 * @return string 返回截取的内容
 */
/*  示例
$str='123/456/789';
cut_str($str,'/',0);  返回 123
cut_str($str,'/',-1);  返回 789
cut_str($str,'/',-2);  返回 456
具体参考 http://http://www.igangly@gmail.com/index.php/Home/Index/article/aid/18
 */
function cut_str($str, $sign, $number) {
	$array = explode($sign, $str);
	$length = count($array);
	if ($number < 0) {
		$new_array = array_reverse($array);
		$abs_number = abs($number);
		if ($abs_number > $length) {
			return 'error';
		} else {
			return $new_array[$abs_number - 1];
		}
	} else {
		if ($number >= $length) {
			return 'error';
		} else {
			return $array[$number];
		}
	}
}
